---
title: "Solr9ã®kuromojiã§UniDic2.1.2ã‚’ä½¿ã†"
emoji: "ğŸŒ„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["solr", "lucene"]
published: true
---

## æ¦‚è¦

Solr9.1ã®kuromojiã§UniDic2.1.2ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

[UniDic](https://clrd.ninjal.ac.jp/unidic/)ã¯å›½ç«‹å›½èªç ”ç©¶æ‰€ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸã€å½¢æ…‹ç´ è§£æå™¨MeCabç”¨ã®è§£æç”¨è¾æ›¸ã§ã™ã€‚
å½¢æ…‹ç´ è§£æç”¨è¾æ›¸ã«ã¯IPA(IPADic)ã‚„NAISTè¾æ›¸ã€NEologdè¾æ›¸ãªã©ãŒã‚ã‚Šã¾ã™ãŒã€IPAè¾æ›¸ã¯2007å¹´ã§ã€NAISTè¾æ›¸ã¯2011å¹´ã§ã€NEologdè¾æ›¸ã¯2020å¹´ã§æ›´æ–°ãŒåœæ­¢ã—ã¦ã„ã¾ã™ã€‚UniDicã¯2022å¹´9æœˆã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³3.1.1ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ãŠã‚Šã€2022å¹´ç¾åœ¨ã§ã‚‚æ›´æ–°ãŒç¶šã„ã¦ã„ã‚‹æ•°å°‘ãªã„è¾æ›¸ã§ã™ã€‚

kuromojiã¯æœ€æ–°ã®UniDic3.1.1ã«ã¯ã¾ã æ­£å¼å¯¾å¿œã—ã¦ã„ãªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ã“ã“ã§ã¯UniDic2.1.2ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚
(UniDic3.1.1ã‚‚ç„¡ç†ã‚„ã‚Šãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€æ­£å¼å¯¾å¿œã—ã¦ã„ãªã„ã®ã¨è¾æ›¸ã‚µã‚¤ã‚ºãŒç´„422MBã¨å¤§ãã„ã®ã§å®Ÿç”¨çš„ã§ã¯ãªã„ã¨æ€ã‚ã‚Œã¾ã™)

å†…å®¹çš„ã«ã¯[ã“ã¡ã‚‰ã®ã‚¨ãƒ³ãƒˆãƒª](https://blog.johtani.info/blog/2019/12/04/about-lucene-4056/)ãã®ã¾ã¾ã§ã™ãŒã€Lucene9ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ãŒApache Antã‹ã‚‰Gradleã«å¤‰æ›´ã«ãªã£ãŸã“ã¨ã§å…ˆäººã®çŸ¥æµãŒãã®ã¾ã¾é©ç”¨ã§ããªã‹ã£ãŸã‚Šã—ãŸã®ã§ã€è¦šæ›¸ã¨ã„ã†ã“ã¨ã§ã“ã®è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚

## ç’°å¢ƒ

- Ubuntu 22.04
- openjdk 11
- Solr 9.1.0
- Lucene 9.3.0

## æ‰‹é †

### Java11ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Java11ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚Ubuntuã®å ´åˆã€`apt`ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
sudo apt install openjdk-11-jdk
```

### Luceneã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

[Luceneã®GitHubãƒªãƒã‚¸ãƒˆãƒª](https://github.com/apache/lucene)ã‹ã‚‰9.3.0ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚
ãƒªãƒã‚¸ãƒˆãƒªã®ã‚µã‚¤ã‚ºãŒéå¸¸ã«å¤§ãã„ã®ã§ã€ã‚·ãƒ£ãƒ­ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

```bash
git clone https://github.com/apache/lucene.git --branch releases/lucene/9.3.0 --depth 1
```

### ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´

Luceneã®ã„ãã¤ã‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚å¤‰æ›´ç®‡æ‰€ã¯[ã“ã¡ã‚‰ã®ã‚¨ãƒ³ãƒˆãƒª](https://blog.johtani.info/blog/2019/12/04/about-lucene-4056/)ã¨ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚

ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’GitHub Gistã«ç”¨æ„ã—ãŸã®ã§ã€ã“ã‚Œã‚’å„ãƒ•ã‚¡ã‚¤ãƒ«ã«é©ç”¨ã—ã¾ã™ã€‚

```bash
curl -O https://gist.githubusercontent.com/fjnkt98/b97a30b23d90a257aaba23efe54861bd/raw/c52efb8b364b40a7336616c69fda5c4076504b5d/DictionaryBuilder.java.patch
curl -O https://gist.githubusercontent.com/fjnkt98/9d298769314bc0875a7809fa08bcf250/raw/d2c9a9ecfecc0b948973c8762458ccf3487ae626/TokenInfoDictionaryBuilder.java.patch
curl -O https://gist.githubusercontent.com/fjnkt98/3e7655081b8141116bd39fd5a4b95e6a/raw/fbfad21fb165d1457affd8f411d06109da1ec95c/UnknownDictionaryBuilder.java.patch
curl -O https://gist.githubusercontent.com/fjnkt98/c6e9cbf47ef062f0ae1ca21380ecbe24/raw/05b1e593d8bf763858448f82829848855033e9a6/kuromoji.gradle.patch

cd lucene
git apply ../TokenInfoDictionaryBuilder.java.patch
git apply ../DictionaryBuilder.java.patch
git apply ../kuromoji.gradle.patch
git apply ../UnknownDictionaryBuilder.java.patch
```

### è¾æ›¸ã®ãƒ“ãƒ«ãƒ‰

è¾æ›¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚`compileUnidic`ã‚’å®Ÿè¡Œã—ãªã„ã¨ipadicã®è¾æ›¸ãŒã§ãã¦ã—ã¾ã†ã®ã§compileUnidicã‚¿ã‚¹ã‚¯ã‚’å˜ä½“ã§å®Ÿè¡Œã—ã¦ã‹ã‚‰å…¨ä½“ãƒ“ãƒ«ãƒ‰ã—ã¾ã™(Gradleã®ä»•æ§˜ãŒã‚ˆãã‚ã‹ã£ã¦ãªã„)

```bash
./gradlew assemble compileUnidic
./gradlew assemble
```


ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã™ã‚‹ã¨ã€`lucene/analysis/kuromoji/build/libs`ä»¥ä¸‹ã«è¾æ›¸ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ä½•ã‚‚è¨­å®šã‚’å¤‰æ›´ã—ã¦ã„ãªã‘ã‚Œã°ã€`lucene-analysis-kuromoji-9.3.0-SNAPSHOT.jar`ã¨ã„ã†åå‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ17MBã«ãªã£ã¦ã„ã‚Œã°OKã§ã™ã€‚

### Dockerfile

è¾æ›¸ã®ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†Dockerfileã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚Dockerã®å®Ÿè¡Œç’°å¢ƒãŒã‚ã‚Œã°ã€è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¤Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä½œæˆã§ãã¾ã™ã€‚

```Dockerfile
FROM openjdk:11.0.16-slim-buster

RUN apt-get update \
    && apt-get install -y git curl \
    && rm -rf /var/lib/apt/lists/*

RUN git clone https://github.com/apache/lucene.git --branch releases/lucene/9.3.0 --depth 1

RUN curl -O https://gist.githubusercontent.com/fjnkt98/b97a30b23d90a257aaba23efe54861bd/raw/c52efb8b364b40a7336616c69fda5c4076504b5d/DictionaryBuilder.java.patch \
    && curl -O https://gist.githubusercontent.com/fjnkt98/9d298769314bc0875a7809fa08bcf250/raw/d2c9a9ecfecc0b948973c8762458ccf3487ae626/TokenInfoDictionaryBuilder.java.patch \
    && curl -O https://gist.githubusercontent.com/fjnkt98/3e7655081b8141116bd39fd5a4b95e6a/raw/fbfad21fb165d1457affd8f411d06109da1ec95c/UnknownDictionaryBuilder.java.patch \
    && curl -O https://gist.githubusercontent.com/fjnkt98/c6e9cbf47ef062f0ae1ca21380ecbe24/raw/05b1e593d8bf763858448f82829848855033e9a6/kuromoji.gradle.patch

RUN cd /lucene \
    && git apply ../TokenInfoDictionaryBuilder.java.patch \
    && git apply ../DictionaryBuilder.java.patch \
    && git apply ../kuromoji.gradle.patch \
    && git apply ../UnknownDictionaryBuilder.java.patch

RUN cd /lucene \
    && ./gradlew clean
# compileUnidicå˜ä½“ã§ãƒ“ãƒ«ãƒ‰ ä½•ã‹ã“ã‚Œã‚„ã‚‰ãªã„ã¨ipadicã®è¾æ›¸ãŒå‡ºæ¥ä¸ŠãŒã‚‹ã®ã§ã“ã®æ‰‹é †ã‚’æŒŸã‚€
RUN cd /lucene \
    && ./gradlew assemble compileUnidic
RUN cd /lucene \
    && ./gradlew assemble

RUN cp /lucene/lucene/analysis/kuromoji/build/libs/lucene-analysis-kuromoji-9.3.0-SNAPSHOT.jar /
```

ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦ã€`docker cp`ã§ãƒ›ã‚¹ãƒˆã«ã‚³ãƒ”ãƒ¼ã™ã‚Œã°è¾æ›¸ãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚

```bash
docker run --rm -it lucene9.3.0-unidic2.1.2:latest bash
```

### Solrã§ä½¿ç”¨ã™ã‚‹

ä½œæˆã—ãŸè¾æ›¸ã‚’Solrã«é…ç½®ã—ã¦ã€å‹•ä½œç¢ºèªã‚’ã—ã¦ã¿ã¾ã™ã€‚

ä½œæˆã—ãŸè¾æ›¸ã‚’Solrã«é©ç”¨ã™ã‚‹ã«ã¯ã€ã¾ãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹kuromojiè¾æ›¸ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`lucene-analysis-kuromoji-9.3.0.jar`ã¨ã„ã†è¾æ›¸ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’å‰Šé™¤ã™ã‚‹ã‹ã€`lucene-analysis-kuromoji-9.3.0.jar.org`ã®ã‚ˆã†ã«ãƒªãƒãƒ¼ãƒ ã™ã‚‹ã‹ã—ã¾ã™ã€‚æ‹¡å¼µå­ãŒ`.jar`ã§ãªããªã‚Œã°ãªã‚“ã§ã‚‚ã‚ˆã„ã§ã™ã€‚

ãã—ã¦ã€ç”Ÿæˆã—ãŸè¾æ›¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ã€‚
`/opt/solr/server/solr-webapp/webapp/WEB-INF/lib`ä»¥ä¸‹ã«ã€ç”Ÿæˆã—ãŸè¾æ›¸ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’é…ç½®ã—ã¾ã™ã€‚

Dockerã§Solrã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªDockerfileã‚’ä½œæˆã™ã‚‹ã¨ç°¡å˜ã«è¾æ›¸å…¥ã‚ŠSolrãŒä½œæˆã§ãã¾ã™ã€‚

```Dockerfile
FROM solr:9.1.0

COPY --chown=solr:solr ./lucene-analysis-kuromoji-9.3.0-unidic-2.1.2.jar /opt/solr/server/solr-webapp/webapp/WEB-INF/lib/lucene-analysis-kuromoji-9.3.0.jar

USER solr
```

ä¸Šè¨˜ã®Dockerfileã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`lucene-analysis-kuromoji-9.3.0-unidic-2.1.2.jar`ã‚’é…ç½®ã—ã€Solrã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã¯å¥½ããªã‚‚ã®ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚

```bash
docker build -t solr-unidic .
```

ä½œæˆã—ãŸSolrã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```bash
docker run -p 8983:8983 --rm solr-unidic:latest solr-precreate example
```

èµ·å‹•å¾Œã«ã‚³ã‚¢ãŒä½œæˆã•ã‚Œã‚‹ã®ã§ã€ãƒ†ã‚­ã‚¹ãƒˆè§£æã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ curl -sS 'http://localhost:8983/solr/example/analysis/field?analysis.fieldtype=text_ja' --get --data-urlencode 'analysis.fieldvalue=è‡ªå‹•è»Šã¨è‡ªè»¢è»Šã®é•ã„ã¯ãªã‚“ã§ã—ã‚‡ã†ï¼Ÿ'  | jq '.analysis.field_types.text_ja.index[13][].text'
"è‡ªå‹•"
"è»Š"
"è‡ªè»¢"
"è»Š"
"é•ã„"
"ãªã‚“"
```

ã€Œè‡ªå‹•è»Šã€ãŒã€Œè‡ªå‹•ã€ã€Œè»Šã€ã«åˆ†å‰²ã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

## å‚è€ƒæ–‡çŒ®

- [Apache Luceneã®Kuromojiã®UniDicãƒ“ãƒ«ãƒ‰å¯¾å¿œãƒ‘ãƒƒãƒã«ã¤ã„ã¦](https://blog.johtani.info/blog/2019/12/04/about-lucene-4056/)
